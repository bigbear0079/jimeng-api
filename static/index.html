<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamina ç®¡ç†åå°</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; padding: 30px 0; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .main-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .el-tabs__header { padding: 0 20px; background: #f8f9fa; }
        .el-tabs__content { padding: 20px; }
        .stats-bar { 
            display: flex; gap: 20px; padding: 15px 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7ed 100%); 
            border-radius: 12px; margin-bottom: 20px; 
        }
        .stat-item { text-align: center; flex: 1; }
        .stat-value { font-size: 28px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
        .toolbar { 
            display: flex; justify-content: space-between; 
            align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; 
        }
        .account-card {
            padding: 20px; border: 1px solid #eee; border-radius: 12px;
            margin-bottom: 15px; transition: all 0.3s;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }
        .account-card:hover { 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            transform: translateY(-2px);
        }
        .account-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .account-title { font-size: 16px; font-weight: bold; color: #333; }
        .credit-bar {
            height: 8px; background: #eee; border-radius: 4px; 
            overflow: hidden; margin: 10px 0;
        }
        .credit-bar-fill {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }
        .credit-detail { display: flex; gap: 15px; font-size: 12px; color: #666; }
        .credit-item { display: flex; align-items: center; gap: 4px; }
        .credit-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-gift { background: #67c23a; }
        .dot-purchase { background: #409eff; }
        .dot-vip { background: #e6a23c; }
        .task-prompt { 
            max-width: 300px; overflow: hidden; 
            text-overflow: ellipsis; white-space: nowrap; 
        }
        .result-preview { 
            max-width: 80px; max-height: 80px; 
            border-radius: 8px; cursor: pointer; 
        }
    </style>
</head>
<body>
<div id="app">
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ Dreamina ç®¡ç†åå°</h1>
            <p>è´¦æˆ·ç®¡ç† Â· ç§¯åˆ†æŸ¥è¯¢ Â· ä»»åŠ¡è®°å½•</p>
        </div>
        
        <div class="main-card">
            <el-tabs v-model="activeTab">
                <!-- å›¾ç‰‡ç”Ÿæˆ -->
                <el-tab-pane label="ğŸ¨ å›¾ç‰‡ç”Ÿæˆ" name="generate">
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-value" style="color: #409eff;">{{ accountStats.total_credits }}</div>
                            <div class="stat-label">å¯ç”¨ç§¯åˆ†</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #67c23a;">{{ accountStats.available_count }}</div>
                            <div class="stat-label">å¯ç”¨è´¦æˆ·</div>
                        </div>
                    </div>
                    
                    <el-form label-width="100px" style="max-width: 800px;">
                        <el-form-item label="æç¤ºè¯">
                            <el-input v-model="generateForm.prompt" type="textarea" :rows="3" 
                                placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡å†…å®¹ï¼Œä¾‹å¦‚ï¼šA cute cat sitting on a windowsill watching the sunset"></el-input>
                        </el-form-item>
                        <el-form-item label="æ¨¡å‹">
                            <el-select v-model="generateForm.model" style="width: 200px;">
                                <el-option label="Jimeng 4.5 (æ¨è)" value="jimeng-4.5"></el-option>
                                <el-option label="Jimeng 4.1" value="jimeng-4.1"></el-option>
                                <el-option label="Jimeng 4.0" value="jimeng-4.0"></el-option>
                                <el-option label="Jimeng 3.0" value="jimeng-3.0"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="æ¯”ä¾‹">
                            <el-radio-group v-model="generateForm.ratio">
                                <el-radio-button label="1:1">1:1 æ­£æ–¹å½¢</el-radio-button>
                                <el-radio-button label="16:9">16:9 æ¨ªå±</el-radio-button>
                                <el-radio-button label="9:16">9:16 ç«–å±</el-radio-button>
                                <el-radio-button label="4:3">4:3</el-radio-button>
                                <el-radio-button label="3:4">3:4</el-radio-button>
                            </el-radio-group>
                        </el-form-item>
                        <el-form-item label="åˆ†è¾¨ç‡">
                            <el-radio-group v-model="generateForm.resolution">
                                <el-radio-button label="1k">1K</el-radio-button>
                                <el-radio-button label="2k">2K (æ¨è)</el-radio-button>
                                <el-radio-button label="4k">4K</el-radio-button>
                            </el-radio-group>
                        </el-form-item>
                        <el-form-item label="è´¦æˆ·">
                            <el-select v-model="generateForm.account_id" placeholder="è‡ªåŠ¨é€‰æ‹©" clearable style="width: 200px;">
                                <el-option v-for="acc in accounts" :key="acc.id" 
                                    :label="'è´¦æˆ· ' + acc.id + ' (' + acc.credits + 'ç§¯åˆ†)'" 
                                    :value="acc.id"
                                    :disabled="acc.credits < 4"></el-option>
                            </el-select>
                            <span style="margin-left: 10px; color: #999; font-size: 12px;">ä¸é€‰åˆ™è‡ªåŠ¨åˆ†é…</span>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" size="large" @click="generateImage" :loading="generating" :disabled="!generateForm.prompt">
                                <el-icon><Picture /></el-icon> ç”Ÿæˆå›¾ç‰‡ (çº¦4ç§¯åˆ†)
                            </el-button>
                        </el-form-item>
                    </el-form>
                    
                    <!-- ç”Ÿæˆç»“æœ -->
                    <div v-if="generateResult" style="margin-top: 20px;">
                        <el-divider>ç”Ÿæˆç»“æœ</el-divider>
                        <div v-if="generateResult.success" style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <div v-for="(url, i) in (generateResult.images || generateResult.data?.data || [])" :key="i" 
                                style="border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <img :src="typeof url === 'string' ? url : url.url" style="max-width: 300px; max-height: 300px; display: block;" @click="previewImage(typeof url === 'string' ? url : url.url)">
                                <div style="padding: 8px; background: #f5f7fa; text-align: center;">
                                    <a :href="typeof url === 'string' ? url : url.url" target="_blank" style="color: #667eea; font-size: 12px;">ä¸‹è½½åŸå›¾</a>
                                </div>
                            </div>
                        </div>
                        <el-alert v-else type="error" :title="generateResult.error || 'ç”Ÿæˆå¤±è´¥'" show-icon></el-alert>
                    </div>
                </el-tab-pane>

                <!-- è´¦æˆ·ç®¡ç† -->
                <el-tab-pane label="ğŸ‘¤ è´¦æˆ·ç®¡ç†" name="accounts">
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-value">{{ accountStats.total_count }}</div>
                            <div class="stat-label">æ€»è´¦æˆ·æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #67c23a;">{{ accountStats.available_count }}</div>
                            <div class="stat-label">å¯ç”¨è´¦æˆ·</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #409eff;">{{ accountStats.total_credits }}</div>
                            <div class="stat-label">æ€»ç§¯åˆ†</div>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <el-button type="primary" @click="refreshAllAccounts" :loading="refreshing">
                            <el-icon><Refresh /></el-icon> åˆ·æ–°æ‰€æœ‰ç§¯åˆ†
                        </el-button>
                        <span style="color: #666; font-size: 13px;">
                            ä¸Šæ¬¡åˆ·æ–°: {{ lastRefreshTime || 'æœªåˆ·æ–°' }}
                        </span>
                    </div>
                    
                    <el-row :gutter="15">
                        <el-col :xs="24" :sm="12" :md="8" :lg="6" v-for="acc in accounts" :key="acc.id">
                            <div class="account-card">
                                <div class="account-header">
                                    <span class="account-title">
                                        è´¦æˆ· {{ acc.id }}
                                        <el-tag size="small" style="margin-left: 8px;">{{ acc.region.toUpperCase() }}</el-tag>
                                    </span>
                                    <el-tag :type="acc.credits >= 4 ? 'success' : 'danger'" size="small">
                                        {{ acc.credits }} ç§¯åˆ†
                                    </el-tag>
                                </div>
                                <div class="credit-bar">
                                    <div class="credit-bar-fill" :style="{ width: Math.min(acc.credits, 100) + '%' }"></div>
                                </div>
                                <div class="credit-detail">
                                    <span class="credit-item">
                                        <span class="credit-dot dot-gift"></span>
                                        èµ é€: {{ acc.gift_credit }}
                                    </span>
                                    <span class="credit-item">
                                        <span class="credit-dot dot-purchase"></span>
                                        è´­ä¹°: {{ acc.purchase_credit }}
                                    </span>
                                    <span class="credit-item">
                                        <span class="credit-dot dot-vip"></span>
                                        VIP: {{ acc.vip_credit }}
                                    </span>
                                </div>
                                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                                    æ›´æ–°: {{ formatTime(acc.last_update) }}
                                </div>
                            </div>
                        </el-col>
                    </el-row>
                </el-tab-pane>

                <!-- ä»»åŠ¡è®°å½• -->
                <el-tab-pane label="ğŸ“‹ ä»»åŠ¡è®°å½•" name="tasks">
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-value">{{ taskStats.total }}</div>
                            <div class="stat-label">æ€»ä»»åŠ¡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #67c23a;">{{ taskStats.by_status?.completed || 0 }}</div>
                            <div class="stat-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #e6a23c;">{{ taskStats.by_status?.pending || 0 }}</div>
                            <div class="stat-label">è¿›è¡Œä¸­</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #f56c6c;">{{ taskStats.by_status?.failed || 0 }}</div>
                            <div class="stat-label">å¤±è´¥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #909399;">{{ taskStats.today }}</div>
                            <div class="stat-label">ä»Šæ—¥ä»»åŠ¡</div>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <div style="display: flex; gap: 10px;">
                            <el-select v-model="taskFilter.status" placeholder="çŠ¶æ€ç­›é€‰" clearable style="width: 120px;">
                                <el-option label="å¾…å¤„ç†" value="pending"></el-option>
                                <el-option label="å·²å®Œæˆ" value="completed"></el-option>
                                <el-option label="å¤±è´¥" value="failed"></el-option>
                            </el-select>
                            <el-select v-model="taskFilter.type" placeholder="ç±»å‹ç­›é€‰" clearable style="width: 120px;">
                                <el-option label="å›¾ç‰‡" value="image"></el-option>
                                <el-option label="è§†é¢‘" value="video"></el-option>
                            </el-select>
                            <el-button @click="loadTasks" :loading="loadingTasks">
                                <el-icon><Search /></el-icon> æŸ¥è¯¢
                            </el-button>
                        </div>
                        <el-button @click="loadTaskStats">
                            <el-icon><Refresh /></el-icon> åˆ·æ–°ç»Ÿè®¡
                        </el-button>
                    </div>
                    
                    <el-table :data="tasks" border stripe>
                        <el-table-column prop="id" label="ID" width="60"></el-table-column>
                        <el-table-column label="ä»»åŠ¡ID" width="180">
                            <template #default="{ row }">
                                <el-link type="primary" @click="goToHistoryQuery(row.task_id, row.account_id)" :underline="false">
                                    {{ row.task_id }}
                                </el-link>
                                <el-button size="small" link @click="copyTaskId(row.task_id)" style="margin-left: 5px;">
                                    <el-icon><CopyDocument /></el-icon>
                                </el-button>
                            </template>
                        </el-table-column>
                        <el-table-column prop="account_id" label="è´¦æˆ·" width="70"></el-table-column>
                        <el-table-column label="ç±»å‹" width="80">
                            <template #default="{ row }">
                                <el-tag :type="row.task_type === 'image' ? 'primary' : 'success'" size="small">
                                    {{ row.task_type === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘' }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="æç¤ºè¯" min-width="200">
                            <template #default="{ row }">
                                <el-tooltip :content="row.prompt" placement="top">
                                    <span class="task-prompt">{{ row.prompt }}</span>
                                </el-tooltip>
                            </template>
                        </el-table-column>
                        <el-table-column label="çŠ¶æ€" width="90">
                            <template #default="{ row }">
                                <el-tag :type="getStatusType(row.status)" size="small">
                                    {{ getStatusText(row.status) }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="ç§¯åˆ†" width="70" prop="credits_used"></el-table-column>
                        <el-table-column label="ç»“æœ" width="100">
                            <template #default="{ row }">
                                <a v-if="row.result_url" :href="row.result_url" target="_blank" style="color: #667eea;">
                                    æŸ¥çœ‹
                                </a>
                                <span v-else style="color: #999;">-</span>
                            </template>
                        </el-table-column>
                        <el-table-column label="åˆ›å»ºæ—¶é—´" width="160">
                            <template #default="{ row }">
                                {{ formatTime(row.created_at) }}
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <el-pagination
                            v-model:current-page="taskPage"
                            :page-size="taskPageSize"
                            :total="taskTotal"
                            layout="prev, pager, next, total"
                            @current-change="loadTasks"
                        ></el-pagination>
                    </div>
                </el-tab-pane>

                <!-- ç§¯åˆ†è®°å½• -->
                <el-tab-pane label="ğŸ’° ç§¯åˆ†è®°å½•" name="credits">
                    <div class="toolbar">
                        <el-select v-model="creditFilter.account_id" placeholder="é€‰æ‹©è´¦æˆ·" clearable style="width: 150px;">
                            <el-option v-for="acc in accounts" :key="acc.id" :label="'è´¦æˆ· ' + acc.id" :value="acc.id"></el-option>
                        </el-select>
                        <el-button @click="loadCreditLogs" :loading="loadingCredits">
                            <el-icon><Search /></el-icon> æŸ¥è¯¢
                        </el-button>
                    </div>
                    
                    <el-table :data="creditLogs" border stripe>
                        <el-table-column prop="id" label="ID" width="60"></el-table-column>
                        <el-table-column prop="account_id" label="è´¦æˆ·" width="80"></el-table-column>
                        <el-table-column label="å˜åŠ¨" width="100">
                            <template #default="{ row }">
                                <span :style="{ color: row.change_amount > 0 ? '#67c23a' : '#f56c6c', fontWeight: 'bold' }">
                                    {{ row.change_amount > 0 ? '+' : '' }}{{ row.change_amount }}
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="change_type" label="ç±»å‹" width="100">
                            <template #default="{ row }">
                                <el-tag size="small" :type="row.change_type === 'consume' ? 'danger' : 'success'">
                                    {{ row.change_type === 'consume' ? 'æ¶ˆè€—' : 'è·å¾—' }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="balance_after" label="ä½™é¢" width="80"></el-table-column>
                        <el-table-column prop="description" label="æè¿°" min-width="200"></el-table-column>
                        <el-table-column label="æ—¶é—´" width="160">
                            <template #default="{ row }">
                                {{ formatTime(row.created_at) }}
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <el-pagination
                            v-model:current-page="creditPage"
                            :page-size="creditPageSize"
                            :total="creditTotal"
                            layout="prev, pager, next, total"
                            @current-change="loadCreditLogs"
                        ></el-pagination>
                    </div>
                </el-tab-pane>

                <!-- å†å²ä»»åŠ¡ (Dreamina API) -->
                <el-tab-pane label="ğŸ• å†å²ä»»åŠ¡" name="history">
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-value" style="color: #409eff;">{{ historyTasks.length }}</div>
                            <div class="stat-label">å½“å‰é¡µä»»åŠ¡æ•°</div>
                        </div>
                    </div>
                    
                    <div class="toolbar">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <el-select v-model="historyFilter.account_id" placeholder="é€‰æ‹©è´¦æˆ·" style="width: 150px;">
                                <el-option v-for="acc in accounts" :key="acc.id" :label="'è´¦æˆ· ' + acc.id" :value="acc.id"></el-option>
                            </el-select>
                            <el-input v-model="historyFilter.history_id" placeholder="è¾“å…¥ä»»åŠ¡IDï¼ˆå¦‚ 215210116614ï¼‰" style="width: 250px;" clearable></el-input>
                            <el-button type="primary" @click="loadHistoryTasks" :loading="loadingHistory">
                                <el-icon><Search /></el-icon> æŸ¥è¯¢ä»»åŠ¡
                            </el-button>
                        </div>
                    </div>
                    
                    <el-alert v-if="!historyFilter.history_id" type="info" :closable="false" style="margin-bottom: 15px;">
                        <template #title>
                            <span>æç¤ºï¼šè¯·ä»æœåŠ¡æ—¥å¿—ä¸­è·å–ä»»åŠ¡ID</span>
                        </template>
                        <div style="font-size: 12px; margin-top: 5px;">
                            æ—¥å¿—ç¤ºä¾‹ï¼š<code style="background: #f5f7fa; padding: 2px 6px; border-radius: 4px;">è½®è¯¢ 276/900: status=50(COMPLETED)... history_id=<strong>215210116614</strong></code>
                        </div>
                    </el-alert>
                    
                    <!-- å†å²ä»»åŠ¡åˆ—è¡¨ -->
                    <el-row :gutter="15" v-if="historyTasks.length > 0">
                        <el-col :xs="24" :sm="12" :md="8" :lg="6" v-for="task in historyTasks" :key="task.id">
                            <div class="account-card" style="cursor: pointer;" @click="viewHistoryDetail(task.id)">
                                <div style="position: relative; margin-bottom: 10px;">
                                    <img v-if="task.cover_url" :src="task.cover_url" 
                                        style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;">
                                    <div v-else style="width: 100%; height: 150px; background: #f5f7fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
                                        æ— å°é¢
                                    </div>
                                    <el-tag :type="getHistoryStatusType(task.status)" size="small" 
                                        style="position: absolute; top: 8px; right: 8px;">
                                        {{ task.status_text }}
                                    </el-tag>
                                </div>
                                <div style="font-size: 14px; font-weight: 500; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ task.title || 'æ— æ ‡é¢˜' }}
                                </div>
                                <div style="font-size: 12px; color: #999;">
                                    ID: {{ task.id }}
                                </div>
                                <div style="font-size: 12px; color: #999;">
                                    {{ formatTimestamp(task.update_time) }}
                                </div>
                            </div>
                        </el-col>
                    </el-row>
                    
                    <el-empty v-else-if="!loadingHistory" description="æš‚æ— å†å²ä»»åŠ¡ï¼Œè¯·é€‰æ‹©è´¦æˆ·åç‚¹å‡»æŸ¥è¯¢"></el-empty>
                    
                    <!-- ä»»åŠ¡è¯¦æƒ…å¯¹è¯æ¡† -->
                    <el-dialog v-model="historyDetailVisible" title="ä»»åŠ¡è¯¦æƒ…" width="800px">
                        <div v-if="historyDetail">
                            <div style="margin-bottom: 15px;">
                                <el-descriptions :column="2" border>
                                    <el-descriptions-item label="ä»»åŠ¡ID">{{ historyDetail.history_id }}</el-descriptions-item>
                                    <el-descriptions-item label="çŠ¶æ€">
                                        <el-tag :type="historyDetail.status === 50 ? 'success' : historyDetail.status === 30 ? 'danger' : 'warning'">
                                            {{ historyDetail.status === 50 ? 'å·²å®Œæˆ' : historyDetail.status === 30 ? 'å¤±è´¥' : 'å¤„ç†ä¸­' }}
                                        </el-tag>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="å®Œæˆæ—¶é—´">{{ formatTimestamp(historyDetail.finish_time) }}</el-descriptions-item>
                                    <el-descriptions-item label="å›¾ç‰‡æ•°é‡">{{ historyDetail.images?.length || 0 }}</el-descriptions-item>
                                </el-descriptions>
                            </div>
                            
                            <div v-if="historyDetail.images && historyDetail.images.length > 0">
                                <div style="font-weight: 500; margin-bottom: 10px;">ç”Ÿæˆçš„å›¾ç‰‡ï¼š</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div v-for="(img, i) in historyDetail.images" :key="i" 
                                        style="border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                        <img :src="img.cover_url || img.url" 
                                            style="max-width: 200px; max-height: 200px; display: block; cursor: pointer;"
                                            @click="previewImage(img.url || img.cover_url)">
                                        <div style="padding: 8px; background: #f5f7fa;">
                                            <div style="font-size: 12px; color: #666; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                {{ img.description || 'æ— æè¿°' }}
                                            </div>
                                            <a v-if="img.url" :href="img.url" target="_blank" style="color: #667eea; font-size: 12px;">ä¸‹è½½åŸå›¾</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <el-empty v-else description="æš‚æ— å›¾ç‰‡"></el-empty>
                        </div>
                        <div v-else style="text-align: center; padding: 40px;">
                            <el-icon class="is-loading" :size="40"><Loading /></el-icon>
                            <div style="margin-top: 10px; color: #999;">åŠ è½½ä¸­...</div>
                        </div>
                    </el-dialog>
                </el-tab-pane>
            </el-tabs>
        </div>
    </div>
    
    <!-- å›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡† -->
    <el-dialog v-model="previewVisible" width="auto" :show-close="true">
        <img :src="previewUrl" style="max-width: 90vw; max-height: 80vh;">
    </el-dialog>
</div>


<script>
const { createApp, ref, computed, onMounted } = Vue;

const app = createApp({
    setup() {
        const activeTab = ref('generate');
        
        // ========== å›¾ç‰‡ç”Ÿæˆ ==========
        const generateForm = ref({
            prompt: '',
            model: 'jimeng-4.5',
            ratio: '1:1',
            resolution: '2k',
            account_id: null,
        });
        const generating = ref(false);
        const generateResult = ref(null);
        
        const generateImage = async () => {
            if (!generateForm.value.prompt) {
                ElementPlus.ElMessage.warning('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }
            
            generating.value = true;
            generateResult.value = null;
            
            try {
                const resp = await fetch('/api/generate/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(generateForm.value),
                });
                
                const data = await resp.json();
                
                if (resp.ok) {
                    generateResult.value = data;
                    if (data.success) {
                        ElementPlus.ElMessage.success(`ç”ŸæˆæˆåŠŸï¼ä½¿ç”¨è´¦æˆ· ${data.account_id}`);
                        // åˆ·æ–°è´¦æˆ·ç§¯åˆ†
                        loadAccounts();
                    } else {
                        generateResult.value = { success: false, error: data.data?.message || 'ç”Ÿæˆå¤±è´¥' };
                    }
                } else {
                    generateResult.value = { success: false, error: data.detail || 'è¯·æ±‚å¤±è´¥' };
                }
            } catch (e) {
                generateResult.value = { success: false, error: e.message };
            } finally {
                generating.value = false;
            }
        };
        
        // å›¾ç‰‡é¢„è§ˆ
        const previewVisible = ref(false);
        const previewUrl = ref('');
        const previewImage = (url) => {
            previewUrl.value = url;
            previewVisible.value = true;
        };
        
        // ========== è´¦æˆ·ç®¡ç† ==========
        const accounts = ref([]);
        const accountStats = ref({ total_count: 0, available_count: 0, total_credits: 0 });
        const refreshing = ref(false);
        const lastRefreshTime = ref('');
        
        const loadAccounts = async () => {
            try {
                const resp = await fetch('/api/accounts');
                const data = await resp.json();
                accounts.value = data.accounts;
                accountStats.value = {
                    total_count: data.total_count,
                    available_count: data.available_count,
                    total_credits: data.total_credits,
                };
            } catch (e) {
                console.error('åŠ è½½è´¦æˆ·å¤±è´¥:', e);
            }
        };
        
        const refreshAllAccounts = async () => {
            refreshing.value = true;
            try {
                await fetch('/api/accounts/refresh', { method: 'POST' });
                await loadAccounts();
                lastRefreshTime.value = new Date().toLocaleString();
                ElementPlus.ElMessage.success('åˆ·æ–°æˆåŠŸ');
            } catch (e) {
                ElementPlus.ElMessage.error('åˆ·æ–°å¤±è´¥');
            } finally {
                refreshing.value = false;
            }
        };
        
        // ========== ä»»åŠ¡è®°å½• ==========
        const tasks = ref([]);
        const taskStats = ref({ total: 0, today: 0, by_status: {}, by_type: {} });
        const taskFilter = ref({ status: '', type: '' });
        const taskPage = ref(1);
        const taskPageSize = ref(20);
        const taskTotal = ref(0);
        const loadingTasks = ref(false);
        
        const loadTasks = async () => {
            loadingTasks.value = true;
            try {
                const params = new URLSearchParams({
                    page: taskPage.value,
                    page_size: taskPageSize.value,
                });
                if (taskFilter.value.status) params.append('status', taskFilter.value.status);
                if (taskFilter.value.type) params.append('task_type', taskFilter.value.type);
                
                const resp = await fetch(`/api/tasks?${params}`);
                const data = await resp.json();
                tasks.value = data.tasks;
                taskTotal.value = data.total;
            } catch (e) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', e);
            } finally {
                loadingTasks.value = false;
            }
        };
        
        const loadTaskStats = async () => {
            try {
                const resp = await fetch('/api/tasks/stats');
                taskStats.value = await resp.json();
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
            }
        };
        
        // ========== ç§¯åˆ†è®°å½• ==========
        const creditLogs = ref([]);
        const creditFilter = ref({ account_id: null });
        const creditPage = ref(1);
        const creditPageSize = ref(50);
        const creditTotal = ref(0);
        const loadingCredits = ref(false);
        
        const loadCreditLogs = async () => {
            loadingCredits.value = true;
            try {
                const params = new URLSearchParams({
                    page: creditPage.value,
                    page_size: creditPageSize.value,
                });
                if (creditFilter.value.account_id) params.append('account_id', creditFilter.value.account_id);
                
                const resp = await fetch(`/api/credit-logs?${params}`);
                const data = await resp.json();
                creditLogs.value = data.logs;
                creditTotal.value = data.total;
            } catch (e) {
                console.error('åŠ è½½ç§¯åˆ†è®°å½•å¤±è´¥:', e);
            } finally {
                loadingCredits.value = false;
            }
        };
        
        // ========== å†å²ä»»åŠ¡ (Dreamina API) ==========
        const historyTasks = ref([]);
        const historyFilter = ref({ account_id: 1, scene: 'image', history_id: '' });
        const loadingHistory = ref(false);
        const historyDetail = ref(null);
        const historyDetailVisible = ref(false);
        const loadingHistoryDetail = ref(false);
        
        const loadHistoryTasks = async () => {
            if (!historyFilter.value.account_id) {
                ElementPlus.ElMessage.warning('è¯·é€‰æ‹©è´¦æˆ·');
                return;
            }
            
            if (!historyFilter.value.history_id) {
                ElementPlus.ElMessage.warning('è¯·è¾“å…¥ä»»åŠ¡ID');
                return;
            }
            
            loadingHistory.value = true;
            try {
                const params = new URLSearchParams({
                    account_id: historyFilter.value.account_id,
                    scene: historyFilter.value.scene,
                    history_id: historyFilter.value.history_id,
                    page: 1,
                    page_size: 20,
                });
                
                const resp = await fetch(`/api/history?${params}`);
                const data = await resp.json();
                
                if (data.success) {
                    historyTasks.value = data.tasks;
                    if (data.tasks.length > 0) {
                        ElementPlus.ElMessage.success(`æŸ¥è¯¢åˆ° ${data.tasks.length} ä¸ªä»»åŠ¡`);
                    } else {
                        ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°è¯¥ä»»åŠ¡');
                    }
                } else {
                    ElementPlus.ElMessage.error(data.detail || 'æŸ¥è¯¢å¤±è´¥');
                }
            } catch (e) {
                console.error('åŠ è½½å†å²ä»»åŠ¡å¤±è´¥:', e);
                ElementPlus.ElMessage.error('æŸ¥è¯¢å¤±è´¥: ' + e.message);
            } finally {
                loadingHistory.value = false;
            }
        };
        
        const loadHistoryDetail = async () => {
            if (!historyFilter.value.history_id) {
                ElementPlus.ElMessage.warning('è¯·è¾“å…¥ä»»åŠ¡ID');
                return;
            }
            
            loadingHistoryDetail.value = true;
            historyDetail.value = null;
            historyDetailVisible.value = true;
            
            try {
                const params = new URLSearchParams({
                    account_id: historyFilter.value.account_id || 1,
                });
                
                const resp = await fetch(`/api/history/${historyFilter.value.history_id}?${params}`);
                const data = await resp.json();
                
                if (data.success) {
                    historyDetail.value = data;
                } else {
                    ElementPlus.ElMessage.error(data.detail || 'æŸ¥è¯¢å¤±è´¥');
                    historyDetailVisible.value = false;
                }
            } catch (e) {
                console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', e);
                ElementPlus.ElMessage.error('æŸ¥è¯¢å¤±è´¥: ' + e.message);
                historyDetailVisible.value = false;
            } finally {
                loadingHistoryDetail.value = false;
            }
        };
        
        const viewHistoryDetail = async (historyId) => {
            historyFilter.value.history_id = historyId;
            await loadHistoryDetail();
        };
        
        const getHistoryStatusType = (status) => {
            const map = { 0: 'info', 1: 'warning', 2: 'success', 3: 'danger' };
            return map[status] || 'info';
        };
        
        const formatTimestamp = (ts) => {
            if (!ts) return '-';
            try {
                const date = new Date(ts * 1000);
                return date.toLocaleString('zh-CN', { 
                    month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit' 
                });
            } catch {
                return '-';
            }
        };
        
        // ========== å·¥å…·å‡½æ•° ==========
        const formatTime = (timeStr) => {
            if (!timeStr) return '-';
            try {
                const date = new Date(timeStr);
                return date.toLocaleString('zh-CN', { 
                    month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit' 
                });
            } catch {
                return timeStr.slice(0, 16).replace('T', ' ');
            }
        };
        
        const getStatusType = (status) => {
            const map = {
                'pending': 'warning',
                'processing': 'primary',
                'completed': 'success',
                'failed': 'danger',
            };
            return map[status] || 'info';
        };
        
        const getStatusText = (status) => {
            const map = {
                'pending': 'å¾…å¤„ç†',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'timeout': 'è¶…æ—¶',
            };
            return map[status] || status;
        };
        
        // è·³è½¬åˆ°å†å²ä»»åŠ¡æŸ¥è¯¢
        const goToHistoryQuery = (taskId, accountId) => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ Dreamina çš„ history_idï¼ˆçº¯æ•°å­—ä¸”é•¿åº¦å¤§äº10ï¼‰
            if (/^\d{10,}$/.test(taskId)) {
                activeTab.value = 'history';
                historyFilter.value.account_id = accountId;
                historyFilter.value.history_id = taskId;
            } else {
                // æœ¬åœ°ç”Ÿæˆçš„ task_idï¼Œæç¤ºç”¨æˆ·
                ElementPlus.ElMessage.info('è¿™æ˜¯æœ¬åœ°ä»»åŠ¡IDï¼Œè¯·ä»æ—¥å¿—ä¸­è·å– Dreamina çš„ history_idï¼ˆå¦‚ 215210116614ï¼‰');
                activeTab.value = 'history';
                historyFilter.value.account_id = accountId;
                historyFilter.value.history_id = '';
            }
        };
        
        // å¤åˆ¶ä»»åŠ¡ID
        const copyTaskId = async (taskId) => {
            try {
                await navigator.clipboard.writeText(taskId);
                ElementPlus.ElMessage.success('å·²å¤åˆ¶ä»»åŠ¡ID');
            } catch (e) {
                ElementPlus.ElMessage.error('å¤åˆ¶å¤±è´¥');
            }
        };
        
        // ========== åˆå§‹åŒ– ==========
        onMounted(() => {
            loadAccounts();
            loadTaskStats();
            loadTasks();
            loadCreditLogs();
        });
        
        return {
            activeTab,
            // ç”Ÿæˆ
            generateForm, generating, generateResult, generateImage,
            previewVisible, previewUrl, previewImage,
            // è´¦æˆ·
            accounts, accountStats, refreshing, lastRefreshTime,
            loadAccounts, refreshAllAccounts,
            // ä»»åŠ¡
            tasks, taskStats, taskFilter, taskPage, taskPageSize, taskTotal, loadingTasks,
            loadTasks, loadTaskStats,
            // ç§¯åˆ†
            creditLogs, creditFilter, creditPage, creditPageSize, creditTotal, loadingCredits,
            loadCreditLogs,
            // å†å²ä»»åŠ¡
            historyTasks, historyFilter, loadingHistory,
            historyDetail, historyDetailVisible, loadingHistoryDetail,
            loadHistoryTasks, loadHistoryDetail, viewHistoryDetail, getHistoryStatusType, formatTimestamp,
            // å·¥å…·
            formatTime, getStatusType, getStatusText, goToHistoryQuery, copyTaskId,
        };
    }
});

// æ³¨å†Œå›¾æ ‡
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
    app.component(key, component);
}

app.use(ElementPlus);
app.mount('#app');
</script>
</body>
</html>
